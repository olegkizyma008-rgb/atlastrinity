name: MCP Server Tests

on:
  push:
    branches: [main, vibe2]
    paths:
      - 'src/mcp_server/**'
      - 'vendor/mcp-server-macos-use/**'
      - 'requirements.txt'
      - 'package.json'
  pull_request:
    branches: [main]
  workflow_dispatch: {}
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '22'

jobs:
  # ============================================
  # Tier 1: Critical MCP Servers (Must Pass)
  # ============================================
  
  test-tier1-servers:
    name: Test Tier 1 MCP Servers
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node & Bun
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Bun (for fast MCP server startup)
        if: matrix.os == 'macos-latest'
        run: curl -fsSL https://bun.sh/install | bash

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-timeout

      - name: Install NPM dependencies
        run: npm ci

      - name: Compile Swift binary (macOS only)
        if: matrix.os == 'macos-latest'
        run: |
          cd vendor/mcp-server-macos-use
          swift build -c release
          ls -la .build/release/

      - name: Test filesystem server
        run: |
          pytest tests/test_mcp_preflight.py::test_filesystem_connection -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Test terminal server
        run: |
          pytest tests/test_all_mcp_servers.py -k terminal -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Test sequential-thinking server
        run: |
          pytest tests/test_all_mcp_servers.py -k sequential -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Test macos-use server (macOS only)
        if: matrix.os == 'macos-latest'
        run: |
          pytest tests/test_all_mcp_servers.py -k macos -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

  # ============================================
  # Tier 2-4: Extended MCP Server Tests
  # ============================================
  
  test-extended-servers:
    name: Test Extended MCP Servers
    runs-on: ubuntu-latest
    needs: test-tier1-servers
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          npm ci

      - name: Test git server
        run: |
          pytest tests/test_all_mcp_servers.py -k git -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Test memory server
        run: |
          pytest tests/test_all_mcp_servers.py -k memory -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Test vibe server
        run: |
          pytest tests/test_all_mcp_servers.py -k vibe -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Test chrome-devtools server
        run: |
          pytest tests/test_all_mcp_servers.py -k chrome -v
        continue-on-error: true  # May require Chrome installation
        env:
          PYTHONPATH: ${{ github.workspace }}/src

  # ============================================
  # MCP Configuration & Health Checks
  # ============================================
  
  mcp-health-check:
    name: MCP Health & Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate MCP configuration schema
        run: python scripts/ci/validate_mcp_config.py

      - name: Check MCP server imports
        run: |
          python -m pip install -r requirements.txt
          pytest tests/test_mcp_servers_imports.py -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Verify MCP config sync
        run: |
          if [ -f ~/.config/atlastrinity/mcp/config.json ]; then
            echo "Global config exists"
          else
            echo "No global config (expected in CI)"
          fi

  # ============================================
  # Integration: Full MCP Stack Test
  # ============================================
  
  test-full-mcp-stack:
    name: Full MCP Stack Integration
    runs-on: macos-latest
    needs: [test-tier1-servers, test-extended-servers]
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Bun
        run: curl -fsSL https://bun.sh/install | bash

      - name: Install all dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          npm ci

      - name: Compile Swift MCP server
        run: |
          cd vendor/mcp-server-macos-use
          swift build -c release

      - name: Run full MCP stack verification
        run: python scripts/verify_all_mcp.py
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Generate MCP health report
        run: python scripts/check_mcp_health.py
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}/src

  # ============================================
  # Status Summary
  # ============================================
  
  mcp-status:
    name: MCP Tests Status
    runs-on: ubuntu-latest
    needs:
      - test-tier1-servers
      - test-extended-servers
      - mcp-health-check
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.test-tier1-servers.result }}" != "success" ]]; then
            echo "❌ Tier 1 servers failed (critical)"
            exit 1
          fi
          if [[ "${{ needs.mcp-health-check.result }}" != "success" ]]; then
            echo "❌ MCP health check failed"
            exit 1
          fi
          echo "✅ MCP server tests passed"
