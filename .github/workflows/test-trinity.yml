name: Trinity Agent Tests

on:
  push:
    branches: [main, vibe2]
    paths:
      - 'src/brain/**'
      - 'providers/**'
      - 'tests/test_trinity*.py'
  pull_request:
    branches: [main]
  workflow_dispatch: {}

env:
  PYTHON_VERSION: '3.12'

jobs:
  # ============================================
  # Trinity Core Tests
  # ============================================
  
  test-trinity-core:
    name: Trinity Core Logic Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-timeout

      - name: Test Trinity orchestration
        run: |
          pytest tests/test_trinity_core.py -v --timeout=120
        env:
          PYTHONPATH: ${{ github.workspace }}/src
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Test agent handoff logic
        run: |
          pytest tests/test_handoff.py -v --timeout=60
        env:
          PYTHONPATH: ${{ github.workspace }}/src

  # ============================================
  # Agent-Specific Tests
  # ============================================
  
  test-atlas-agent:
    name: Atlas (Planner) Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Test Atlas planning capabilities
        run: |
          pytest tests/ -k atlas -v --timeout=90
        continue-on-error: true  # May require API keys
        env:
          PYTHONPATH: ${{ github.workspace }}/src
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  test-tetyana-agent:
    name: Tetyana (Executor) Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node (for MCP servers)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
          npm ci

      - name: Test Tetyana tool execution
        run: |
          pytest tests/ -k tetyana -v --timeout=90
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}/src
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  test-grisha-agent:
    name: Grisha (Critic) Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Test Grisha verification logic
        run: |
          pytest tests/test_grisha_real.py tests/verify_grisha_logic.py -v --timeout=90
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}/src
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  # ============================================
  # Scenario-Based Integration Tests
  # ============================================
  
  test-trinity-scenarios:
    name: Trinity Real-World Scenarios
    runs-on: ubuntu-latest
    needs: [test-trinity-core]
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install all dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-timeout
          npm ci

      - name: Run Trinity scenario tests
        run: |
          pytest tests/test_trinity_scenarios.py -v --timeout=300
        continue-on-error: true  # Scenarios may be flaky
        env:
          PYTHONPATH: ${{ github.workspace }}/src
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          COPILOT_API_KEY: ${{ secrets.COPILOT_API_KEY }}

      - name: Upload scenario results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trinity-scenario-results
          path: |
            pytest-results.xml
            *.log

  # ============================================
  # Database & Knowledge Graph Tests
  # ============================================
  
  test-knowledge-graph:
    name: Knowledge Graph Integration
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: atlastrinity_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Initialize test database
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d atlastrinity_test -c "SELECT version();"
        env:
          PGPASSWORD: postgres

      - name: Test knowledge graph operations
        run: |
          pytest tests/ -k "graph or knowledge" -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/atlastrinity_test
          REDIS_URL: redis://localhost:6379

  # ============================================
  # Status Summary
  # ============================================
  
  trinity-status:
    name: Trinity Tests Status
    runs-on: ubuntu-latest
    needs:
      - test-trinity-core
      - test-atlas-agent
      - test-tetyana-agent
      - test-grisha-agent
      - test-knowledge-graph
    if: always()
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.test-trinity-core.result }}" != "success" ]]; then
            echo "❌ Trinity core tests failed"
            exit 1
          fi
          if [[ "${{ needs.test-knowledge-graph.result }}" != "success" ]]; then
            echo "❌ Knowledge graph tests failed"
            exit 1
          fi
          echo "✅ Trinity tests passed"
