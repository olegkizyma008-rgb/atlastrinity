name: CI Core Pipeline

on:
  push:
    branches: [main, vibe2, develop]
  pull_request:
    branches: [main]
  workflow_dispatch: {}

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '22'

jobs:
  # ============================================
  # Linting Jobs
  # ============================================
  
  lint-python:
    name: Lint Python (flake8)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy

      - name: Run flake8
        run: flake8 src/ --exclude=dist_venv,node_modules,.venv

      - name: Check black formatting
        run: black --check src tests scripts --exclude='(dist_venv|node_modules|\.venv)'

      - name: Check isort imports
        run: isort --check-only src tests scripts --skip dist_venv --skip node_modules --skip .venv

      - name: Run mypy (type checking)
        run: mypy src --ignore-missing-imports
        continue-on-error: true  # Don't fail on type errors yet

  lint-typescript:
    name: Lint TypeScript/React
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint:ts

      - name: Check Prettier formatting
        run: npm run format:check

  # ============================================
  # Testing Jobs
  # ============================================
  
  test-python:
    name: Python Tests & Coverage
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.11', '3.12']
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-timeout

      - name: Run unit tests with coverage
        run: |
          pytest tests/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=term \
            --junit-xml=pytest-results.xml \
            --timeout=60 \
            -v
        env:
          PYTHONPATH: ${{ github.workspace }}/src

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
        with:
          name: coverage-report
          path: |
            coverage.xml
            pytest-results.xml

  # ============================================
  # Build Jobs
  # ============================================
  
  build-typescript:
    name: Build TypeScript & Electron
    runs-on: ubuntu-latest
    needs: [lint-typescript]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build renderer (Vite)
        run: npm run build:renderer

      - name: Build electron (TypeScript)
        run: npm run build:electron

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-build
          path: dist/

  # ============================================
  # Configuration Validation
  # ============================================
  
  validate-configs:
    name: Validate MCP & System Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate MCP configuration
        run: python scripts/ci/validate_mcp_config.py

      - name: Check JSON syntax
        run: |
          find . -name "*.json" -not -path "./node_modules/*" -not -path "./dist_venv/*" -exec python -m json.tool {} \; > /dev/null

      - name: Validate package.json
        run: |
          npm install --package-lock-only
          git diff --exit-code package-lock.json || (echo "package-lock.json is out of sync" && exit 1)

  # ============================================
  # Analysis Jobs
  # ============================================

  sonar-analysis:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: [test-python]  # Needs coverage report
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
          submodules: recursive

      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: .

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}
        continue-on-error: true # Don't fail CI if Sonar fails (e.g. missing secrets)

  # ============================================
  # Status Summary
  # ============================================
  
  ci-status:
    name: CI Status Check
    runs-on: ubuntu-latest
    needs: 
      - lint-python
      - lint-typescript
      - test-python
      - build-typescript
      - validate-configs
      - sonar-analysis
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [[ "${{ needs.lint-python.result }}" != "success" ]] || \
             [[ "${{ needs.lint-typescript.result }}" != "success" ]] || \
             [[ "${{ needs.test-python.result }}" != "success" ]] || \
             [[ "${{ needs.build-typescript.result }}" != "success" ]] || \
             [[ "${{ needs.validate-configs.result }}" != "success" ]]; then
            echo "❌ One or more CI jobs failed"
            exit 1
          fi
          
          # Check Sonar status but don't fail hard if it was skipped or failed due to missing secrets/config
          if [[ "${{ needs.sonar-analysis.result }}" == "failure" ]]; then
             echo "⚠️ SonarQube analysis failed (check logs/secrets)"
          fi

          echo "✅ All critical CI jobs passed successfully"
